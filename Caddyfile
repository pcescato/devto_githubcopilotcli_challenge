# Caddyfile - Reverse proxy configuration for DEV.to Analytics
# Handles routing for all services with automatic HTTPS (for production)

# Global options
{
    # Uncomment for production with real domains
    # email admin@devto-analytics.com
    
    # Local development - disable automatic HTTPS and use HTTP port
    auto_https off
    
    # Bind to HTTP port 80
    http_port 80
    
    # Admin API (needed for reloads)
    admin 0.0.0.0:2019
    
    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# FastAPI Application - Main analytics API
http://analytics.local {
    reverse_proxy localhost:8000 {
        # Health check (note: FastAPI health is at /api/health)
        health_uri /api/health
        health_interval 10s
        health_timeout 5s
        
        # Load balancing (for future scaling)
        lb_policy round_robin
        
        # Headers
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    # Enable compression
    encode gzip zstd
    
    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains" {
            defer
        }
    }
    
    # CORS (adjust for production)
    @cors_preflight {
        method OPTIONS
    }
    handle @cors_preflight {
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization"
        header Access-Control-Max-Age "3600"
        respond "" 204
    }
    
    # API rate limiting (optional)
    # rate_limit {
    #     zone api_zone {
    #         key {remote_host}
    #         events 100
    #         window 1m
    #     }
    # }
    
    # Logging
    log {
        output file /var/log/caddy/analytics.log
        format json
    }
}

# DbGate - Database management interface
http://db.local {
    reverse_proxy localhost:3000 {
        # Health check
        health_uri /
        health_interval 10s
        health_timeout 5s
        
        # Headers
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    # Enable compression
    encode gzip zstd
    
    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
    }
    
    # Basic auth (uncomment for production)
    # basicauth {
    #     admin $2a$14$Zkx19XLiW6VYouLHR5NmfOFU0z2GTNmpkT/5qqR7hx4IjWJPDhjvG
    # }
    
    # Logging
    log {
        output file /var/log/caddy/dbgate.log
        format json
    }
}

# Apache Superset - Business intelligence dashboards
http://dashboard.local {
    reverse_proxy localhost:8088 {
        # Health check
        health_uri /health
        health_interval 10s
        health_timeout 5s
        
        # Headers
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up Host {host}
        
        # Increase timeout for long-running queries
        transport http {
            read_timeout 5m
            write_timeout 5m
            dial_timeout 30s
        }
    }
    
    # Enable compression
    encode gzip zstd
    
    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
    
    # Static file caching
    @static {
        path /static/*
    }
    header @static Cache-Control "public, max-age=31536000, immutable"
    
    # Logging
    log {
        output file /var/log/caddy/superset.log
        format json
    }
}

# Streamlit Dashboard - Interactive analytics UI
http://streamlit.local {
    reverse_proxy localhost:8501 {
        # Health check
        health_uri /_stcore/health
        health_interval 10s
        health_timeout 5s
        
        # Headers
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up Host {host}
        
        # Increase timeout for long-running operations
        transport http {
            read_timeout 5m
            write_timeout 5m
            dial_timeout 30s
        }
    }
    
    # Enable compression (but not for WebSocket)
    encode gzip zstd
    
    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
    
    # Static file caching
    @static {
        path /static/*
    }
    header @static Cache-Control "public, max-age=31536000, immutable"
    
    # Logging
    log {
        output file /var/log/caddy/streamlit.log
        format json
    }
}

# Root domain - Documentation or landing page
http://devto-analytics.local {
    root * /var/www/devto-analytics
    file_server
    
    # Try files, fallback to index
    try_files {path} {path}/ /index.html
    
    # Enable compression
    encode gzip zstd
    
    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
    }
    
    # Logging
    log {
        output file /var/log/caddy/root.log
        format json
    }
}

# Health check endpoint (for all services)
:8080 {
    respond /health 200 {
        body "OK"
    }
}

# Redirect HTTP to HTTPS (for production)
# http:// {
#     redir https://{host}{uri} permanent
# }
